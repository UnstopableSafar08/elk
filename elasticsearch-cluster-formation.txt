━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
### Configurations Explanation
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# hostmap


```yml
# ===================== Cluster Basics =====================

cluster.name: elk-cluster           # Name of the Elasticsearch cluster
node.name: node-1                         # Unique name for this node
node.roles: [ master ]                    # This node acts as a master only. Avaliable values: master, data, ingest etc.

# ===================== Paths ==============================

path.data: /var/lib/elasticsearch         # Directory where data (shards) is stored
path.logs: /var/log/elasticsearch         # Directory for Elasticsearch logs

# ===================== Networking =========================

network.host: 192.168.121.110               # Node's private IP address
http.port: 9200                           # REST API access port
transport.port: 9300                      # Internal cluster communication port

# ===================== Discovery ==========================

discovery.seed_hosts:                     # IPs of all nodes (used for cluster discovery)
  - 192.168.121.110                         # This node
  - 192.168.121.111                        # Another node
  - 192.168.121.112                        # Another node

# Required ONLY during initial cluster boot, 
# Once the cluster is up and running, Comments/remove this line from all nodes' configs to avoid startup issues in the future.
cluster.initial_master_nodes:            
  - node-1                               # Node name (not IP)
  - node-2
  - node-3

# ===================== Security (X-Pack) ==================

xpack.security.enabled: true              # Enables authentication and encryption

xpack.security.http.ssl:                  # HTTPS for REST API (e.g. Kibana)
  enabled: true
  keystore.path: certs/http.p12           # PKCS#12 keystore with HTTPS certificate

xpack.security.transport.ssl:             # Encryption for node-to-node communication
  enabled: true
  verification_mode: certificate          # Verifies certs via truststore
  keystore.path: certs/transport.p12      # Node's own transport cert
  truststore.path: certs/transport.p12    # Certs of other trusted nodes

# ===================== Optional Enhancements ==============

http.host: 0.0.0.0                         # Allow REST API from any interface (secure only with HTTPS)
transport.host: 0.0.0.0                    # Allow internal traffic from any local IP

# ===================== Monitoring / Enrollment ============

xpack.security.enrollment.enabled: false  # Disable auto-enrollment after setup
```


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# elasicsearch.yml
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

cluster.name: elk
node.name: node1

path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

network.host: 192.168.121.110 # or 0.0.0.0, accessiable only by ip from the outside
http.port: 9200
transport.port: 9300

xpack.security.enabled: true
xpack.security.enrollment.enabled: true

xpack.security.http.ssl:
  enabled: true
  key: /etc/elasticsearch/certs/elastic/elastic.key
  certificate: /etc/elasticsearch/certs/elastic/elastic.crt
  certificate_authorities: /etc/elasticsearch/certs/ca/ca.crt
#  keystore.path: certs/http.p12

xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: /etc/elasticsearch/certs/transport.p12
  truststore.path: /etc/elasticsearch/certs/transport.p12

cluster.initial_master_nodes: ["node1"] # node.name
http.host: 192.168.121.110 # or 0.0.0.0, accessiable only by ip from the outside
transport.host: 0.0.0.0



━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Notes
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# i have node1, node2, node3, node4, node5
Install the elasticsearch using rpm repo or using tarball.
    same installation for all the nodes.
    do not start at all.

Configuration of yml file
    cluster.name: elk
    node.name: node1
    network.host: 192.168.121.110
    http.port: 9200
    transport.port: 9300
    cluster.initial_master_nodes: ["node1"] # this is required durig cluster setup, if the cluster formed, comment this line.
    http.host: 192.168.121.110 # or 0.0.0.0, accessiable only by ip from the outside
    transport.host: 0.0.0.0

Daemon reload, enable and start the elasticsearch
Check the status of elasticsearch  | Check the logs /var/log/elasticsearch/
Reset the elastic user password on node-1.
    ### default user password reset
    Note: if you install elasticsearch using tarball then default username and password will be `elastic`:`elastic`.
    /usr/share/elasticsearch/bin/elasticsearch-reset-password -i -u elastic
    /usr/share/elasticsearch/bin/elasticsearch-reset-password -i -u kibana_system # kibana@123#
    ### new password: elastic@123#

    # auto password generate for all services
    # The following commands will generates the passwords for the user: elastic, kibana_system, kibana, beats_system, logstash_system etc.
    /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto 

    ### check the SSL works or not.
    curl -X GET -u elastic:elastic@123# https://192.168.121.110:9200 --cacert /etc/elasticsearc/cert/ca/ca.crt


verification
    curl -X GET -k -u elastic:elastic@123# https://192.168.121.110:9200
    curl -X GET -k -u elastic:elastic@123# https://192.168.121.110:9200/_cluster/health?pretty
    curl -X GET -k -u elastic:elastic@123# https://192.168.121.110:9200/_cat/nodes?pretty
    curl -X GET -k -u elastic:elastic@123# https://192.168.121.110:9200/_cat/master?pretty

create a enrollment token (ON node1) 
- this token will be expired on 30min, 
- so joins cluster with in 30 min.
- or after that the 30min you have to regenerate the new tokens to join the remaining nodes to cluster.
    /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s node

# Node2,3,4,5
Joining a cluster(ON node2,3,4,5).
    /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node --enrollment-token <paste the token>

    # informations.
    if the elasticsearch Node already initialized or reused/re-IP.
        /usr/share/elasticsearch/bin/elasticsearch --reconfigure-node

    if the elasticsearch Brand-new node, never started.
        /usr/share/elasticsearch/bin/elasticsearch --enrollment-token <paste-token-here>
    
    | Command                                                                 | Purpose                                                                 | When to Use                                              | Output/Behavior                                                                  |
|-------------------------------------------------------------------------|-------------------------------------------------------------------------|----------------------------------------------------------|----------------------------------------------------------------------------------|
| `/usr/share/elasticsearch/bin/elasticsearch --reconfigure-node`        | Reconfigures an existing node’s identity (CA, certs, node name, etc.)  | When changing cluster name, node name, or rejoining clean | Re-initializes the node settings; may delete old identity files or certs        |
| `/usr/share/elasticsearch/bin/elasticsearch --enrollment-token <token>`| Joins a new node to an existing secured cluster using a token          | When bootstrapping a **new node** into a secure cluster  | Uses the token to fetch CA certs and auto-configures security settings          |

Daemon reload, enable and start the elasticsearch
- at a time only one node can joins so do the above step one by one.

Once the cluster formed, we can update the self-signed certificates or public certificate on the cluster nodes.
- Generates the self-signed CA and SSL certificates on the elasticsearch first node with the help of cert-utils tools.
- Copy the CA certificates to all the nodes path `/etc/elasticsearch/certs/`.
- On node2(and 3,4,5) - generate the certificates by using the copied CA certificate, this will sighed the SSL Certificates.
- now change the ownership of certs and provide the file permission to the certs.
    `chown -R elasticsearch:elasticsearch /etc/elasticsearch/certs`
    `chmod -R 750 /etc/elasticsearch/certs`
Daemon reload, enable and start the elasticsearch


# node2 and node3...node5 setup commands.
sudo rpm -ivh elasticsearch-8.18.0-x86_64.rpm # or yum install elasticsearch -y

# NOTE: the enrollmet-token generated by node1 only validate for 30mins, after the 30min this will not works.
# If the token is not expired, then it will used to join a cluster for all the other node2,3,4,5 within the 30 mins.
# If the token is expired (show the error like: ...with exit code 69) then, new node cant join the cluster. In such a case goto node and regenerate the token and join.
/usr/share/elasticsearch/bin/elasticsearch-reconfigure-node --enrollment-token eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTkyLjE2OC4xMjEuMTEwOjkyMDAiXSwiZmdyIjoiZWViZGJjZTI5OWVkMThiYzFhNzkzODA5NjRjNGIzMThiZWZlMGZmMWI4ZTJkMTc5ZGI3NWIwYWJjOTg5Mzk5YSIsImtleSI6IjI4SnpqSllCcDdZTXVsdWhpWFVMOlBPTHpoZ0hzRDVhQWY0MWlqX1hSaUEifQ==
vi /etc/elasticsearch/jvm.options
vi /etc/elasticsearch/elasticsearch.yml
systemctl daemon-reload
systemctl enable elasticsearch
systemctl start elasticsearch
systemctl status elasticsearch
systemctl stop elasticsearch

#### Get the config only form the yml file.
```bash
grep -v '^\s*#' /etc/elasticsearch/elasticsearch.yml | grep -v '^\s*$'  # get config
```



### The configurations of the nodes during the cluster formation.
node1:
```yml
cluster.name: elk
node.name: node1
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 192.168.121.110
http.port: 9200
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12
cluster.initial_master_nodes: ["node1"]
http.host: 0.0.0.0
```


node2:
```yml
cluster.name: elk
node.name: node1
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 192.168.121.112
http.port: 9200
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12
discovery.seed_hosts: ["192.168.121.110:9300"]
http.host: 0.0.0.0
transport.host: 0.0.0.0
```

node3:
```yml
cluster.name: elk
node.name: node1
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 192.168.121.111
http.port: 9200
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12
discovery.seed_hosts: ["192.168.121.110:9300", "192.168.121.112:9300"]
http.host: 0.0.0.0
transport.host: 0.0.0.0
```

### Update he configurations of the nodes during the cluster formation.
comment the following line if existing on the each nodes.
  `cluster.initial_master_nodes: ["node1"]`

add/verify the ips/dns/hostname of all clustre nodes to the following line
  `transport.host: 0.0.0.0`
  `discovery.seed_hosts: ["192.168.121.110:9300", "192.168.121.112:9300", "192.168.121.111:9300"]`


### updated config of elasticsearch
CMD:  `grep -v '^\s*#' /etc/elasticsearch/elasticsearch.yml | grep -v '^\s*$'  # get config`
Node1:
```yml
cluster.name: elk
node.name: node1
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 192.168.121.110
http.port: 9200
discovery.seed_hosts: ["192.168.121.110:9300", "192.168.121.112:9300", "192.168.121.111:9300"]
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12
http.host: 0.0.0.0
transport.host: 0.0.0.0
```

Node2:
```yml
cluster.name: elk
node.name: node2
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 192.168.121.112
http.port: 9200
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12
discovery.seed_hosts: ["192.168.121.110:9300", "192.168.121.112:9300", "192.168.121.111:9300"]
http.host: 0.0.0.0
transport.host: 0.0.0.0
```

Node3:
```yml
cluster.name: elk
node.name: node3
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 192.168.121.111
http.port: 9200
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12
discovery.seed_hosts: ["192.168.121.110:9300", "192.168.121.112:9300", "192.168.121.111:9300"]
http.host: 0.0.0.0
transport.host: 0.0.0.0
```

### self-signed cert
Node: 
```yml
cluster.name: elk
node.name: node1
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 192.168.121.110
http.port: 9200
http.host: 0.0.0.0
transport.host: 0.0.0.0
discovery.seed_hosts:
  - 192.168.121.110:9300
  - 192.168.121.112:9300
  - 192.168.121.111:9300
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  certificate: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.110.crt
  key: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.110.key
  certificate_authorities:
    - /etc/elasticsearch/certs/ca/ca.crt
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  certificate: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.110.crt
  key: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.110.key
  certificate_authorities:
    - /etc/elasticsearch/certs/ca/ca.crt
```

Node2:
```yml
cluster.name: elk
node.name: node2
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 192.168.121.112
http.port: 9200
http.host: 0.0.0.0
transport.host: 0.0.0.0
discovery.seed_hosts:
  - 192.168.121.110:9300
  - 192.168.121.112:9300
  - 192.168.121.111:9300
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  certificate: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.112.crt
  key: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.112.key
  certificate_authorities:
    - /etc/elasticsearch/certs/ca/ca.crt
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  certificate: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.112.crt
  key: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.112.key
  certificate_authorities:
    - /etc/elasticsearch/certs/ca/ca.crt
```

Node3:
```yml
cluster.name: elk
node.name: node3
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 192.168.121.111
http.port: 9200
http.host: 0.0.0.0
transport.host: 0.0.0.0
discovery.seed_hosts:
  - 192.168.121.110:9300
  - 192.168.121.112:9300
  - 192.168.121.111:9300
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  certificate: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.111.crt
  key: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.111.key
  certificate_authorities:
    - /etc/elasticsearch/certs/ca/ca.crt
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  certificate: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.111.crt
  key: /etc/elasticsearch/certs/elastic/elasticsearch/192.168.121.111.key
  certificate_authorities:
    - /etc/elasticsearch/certs/ca/ca.crt
```

Kibana:
```yml
server.name: kibana.elk.local
server.host: "192.168.121.110" # or 0.0.0.0
server.publicBaseUrl: "https://192.168.121.110:5601"  # kibana Public URL, not required for selfsigned SSL cerificate.
server.port: 5601
server.ssl.enabled: true
server.ssl.certificate: /etc/kibana/certs/elastic/elasticsearch/192.168.121.110.crt
server.ssl.key: /etc/kibana/certs/elastic/elasticsearch/192.168.121.110.key
elasticsearch.hosts: ["https://192.168.121.110:9200"]
elasticsearch.ssl.certificateAuthorities: [ "/etc/kibana/certs/ca/ca.crt" ]
elasticsearch.ssl.verificationMode: certificate
elasticsearch.serviceAccountToken: "AAEAAWVsYXN0aWMva2liYW5hL2tpYmFuYS10b2tlbjpqNG9jdElNVVIzYVMyWmxJRzFKajR3"
```


### ERRORS:
ERROR: Aborting enrolling to cluster. This node does not appear to be auto-configured for security. 
Expected configuration is missing from elasticsearch.yml., with exit code 64

Solutions:
uninstall the elasticsearch completelly.

```bash  
systemctl stop elasticsearch
systemctl disable elasticsearch
yum remove -y elasticsearch
rm -rf /etc/elasticsearch
rm -rf /var/lib/elasticsearch
rm -rf /var/log/elasticsearch
rm -rf /usr/share/elasticsearch
# rm -rf /opt/elasticsearch*  # If you manually installed it here
rm -rf /etc/systemd/system/elasticsearch.service
rm -rf /etc/sysconfig/elasticsearch  # Optional config dir
rm -rf /tmp/elasticsearch*           # Clean any temp files
userdel -r elasticsearch 2>/dev/null
groupdel elasticsearch 2>/dev/null
rpm -qa | grep elastic*
systemctl daemon-reload
```
reboot the server.
reinstall the elasticsearch.
rejoin the cluster by < -reconfigure-node --enrollment-token > with the newly created token by node1


### ERROR
ERROR: Aborting enrolling to cluster. 
Could not communicate with the node on any of the addresses from the enrollment token. 
All of [192.168.121.110:9200] were attempted., with exit code 69

Solutions:
Check the API of the node1
  curl -k https://192.168.121.110:9200 , if get respond then ok.
  check the yml config of node1.
  
rejoin the cluster by < -reconfigure-node --enrollment-token >
  `elasticsearch-reconfigure-node --enrollment-token <token with the newly created token by node1>`

Daemon reload and service restart
  systemctl daemon-reload
  systemctl restart elasticsearch

### Final Check
curl -k -u elastic:elastic@123# -X GET "https://192.168.121.112:9200/_cat/nodes?pretty"
192.168.121.112 53 90 68 0.99 0.43 0.16 cdfhilmrstw - node2
192.168.121.111 53 83 35 0.55 0.26 0.09 cdfhilmrstw - node3
192.168.121.110 48 93  3 0.26 0.21 0.09 cdfhilmrstw * node1


### ERROR
If the cluster_uuid doesnt match, then delete the nodes folder in the data node server,
  `rm -rf /var/lib/elasticsearch/nodes`

and restart
  `sudo service elasticsearch restart`

Check again the cluster health for the correct value
  `curl -XGET 'http://localhost:9200/_cluster/health?pretty'`


### kibana install and setup
install java
add elastic repo
add elastic GPG key.

Install kibana rpm # or yum install kibana -y
  wget https://artifacts.elastic.co/downloads/kibana/kibana-8.18.0-x86_64.rpm
  sudo rpm -ivh kibana-8.18.0-x86_64.rpm
  Do not start the service.

Copy the self-signed certificate that generated earlier on elasticsearch server to kibana server 
certificate path: /etc/kibana/certs/
  mkdir -p /etc/kibana/certs/

### change the Certificate ownership to kibana
  chown -R kibana:kibana /etc/kibana /var/lib/kibana /var/log/kibana
  chown -R kibana:kibana /etc/kibana/certs
  chmod -R 750 /etc/kibana/certs

Create Service Token
  Run this command on the `Elasticsearch server`: 
  /usr/share/elasticsearch/bin/elasticsearch-service-tokens create elastic/kibana kibana-token
  Copy the generated token. This token will be valid for 30 min only, after that it will be expired.

Run this command on the Kibana server: 
  /usr/share/kibana/bin/kibana add elasticsearch.serviceAccountToken 
  Press Enter.
  < Paste in the token after the prompt.>


vi /etc/kibana/kibana.yml
```yml
# configurations
server.port: 5601
server.host: 0.0.0.0 # or host ip
server.publicBaseUrl: "https://192.168.121.110:5601"  # kibana url, not required for selfsigned SSL cerificate.
server.ssl.enabled: true
server.ssl.key: /etc/kibana/certs/kibana/kibana.key
server.ssl.certificate: /etc/kibana/certs/kibana/kibana.crt
server.ssl.certificateAuthorities: /etc/kibana/certs/ca/ca.crt
elasticsearch.hosts: ["https://192.168.121.110:9200"] # elasticsearch API URL with port.
elasticsearch.ssl.verificationMode: full
elasticsearch.ssl.certificateAuthorities: ["/etc/kibana/certs/ca/ca.crt"]
elasticsearch.serviceAccountToken: "elasticsearch kibana-service token here"
```
systemctl daemon-reload
systemctl enable kibana;
systemctl start kibana;
check the logs.
Browser: https://192.168.121.110:5601


#  Cluster formation
vi /etc/kibana/kibana.yml
```yml
# configurations
server.port: 5601
server.host: 0.0.0.0 # or host ip
server.publicBaseUrl: "https://192.168.121.110:5601"  # kibana url, not required for selfsigned SSL cerificate.
server.ssl.enabled: true
server.ssl.key: /etc/kibana/certs/kibana/kibana.key
server.ssl.certificate: /etc/kibana/certs/kibana/kibana.crt
server.ssl.certificateAuthorities: /etc/kibana/certs/ca/ca.crt
elasticsearch.hosts: ["https://192.168.121.110:9200", "https://192.168.121.112:9200", "https://192.168.121.112:9200"] # elasticsearch API URL with port.
elasticsearch.ssl.verificationMode: full
elasticsearch.ssl.certificateAuthorities: ["/etc/kibana/certs/ca/ca.crt"]
elasticsearch.serviceAccountToken: "elasticsearch kibana-service token here"
```

systemctl daemon-reload
systemctl enable kibana;
systemctl start kibana;
check the logs.
Browser: https://192.168.121.110:5601


### complete uninstall
#!/bin/bash

echo "Stopping Kibana service..."
sudo systemctl stop kibana

echo "Removing Kibana via yum..."
sudo yum remove -y kibana

echo "Deleting Kibana directories..."
sudo rm -rf /etc/kibana
sudo rm -rf /var/log/kibana
sudo rm -rf /var/lib/kibana

echo "Reloading systemd and resetting failed units..."
sudo systemctl daemon-reload
#sudo systemctl reset-failed

echo "Kibana has been completely uninstalled."



### create a new user with superuser roles
./elasticsearch-users useradd admin -p 'elastic@123#' -r superuser



━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# ELK with the publically signed CERTS.
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

#### elk with publically signed certs
### ELASTICSEARCH CONFIGURATION.
grep -v '^\s*#' /etc/elasticsearch/elasticsearch.yml | grep -v '^\s*$'  # get es
cluster.name: elk
node.name: elk.sagar.com.np
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: elk.sagar.com.np
http.port: 9200
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  certificate: /etc/elasticsearch/certs/full.crt
  key: /etc/elasticsearch/certs/private.key

# xpack.security.http.ssl.verification_mode: certificate # to fix the error: java.security.cert.CertificateException: No subject alternative names matching IP address 192.168.121.113 found
# xpack.security.http.ssl.verification_mode: full # enable this after password reset or not leave it as comment.

xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12
cluster.initial_master_nodes: ["elk.sagar.com.np"]
http.host: 0.0.0.0

Options of : xpack.security.http.ssl.verification_mode
| Mode          | Meaning                                                                 |
| ------------- | ----------------------------------------------------------------------- |
| `full`        | 🔒 **Strictest** — verifies certificate **trust AND hostname/IP (SAN)** |
| `certificate` | ✅ Verifies certificate **trust only**, skips hostname/IP check          |
| `none`        | ⚠️ No verification at all (⚠️ **Not secure**)                           |




### KIBANA CONFIGURATION.

grep -v '^\s*#' /etc/kibana/kibana.yml | grep -v '^\s*$'  # get kibana
server.port: 5601
server.host: "0.0.0.0"
server.publicBaseUrl: "http://kibana.sagar.com.np:5601"
server.name: "kibana-server"
server.ssl.enabled: true
server.ssl.certificate: /etc/kibana/certs/full.crt
server.ssl.key: /etc/kibana/certs/private.key
elasticsearch.hosts: ["https://elk.sagar.com.np:9200"]
# elasticsearch.username: "kibana_system"
# elasticsearch.password: "elastic@123#"
elasticsearch.serviceAccountToken: "AAEAAWVsYXN0aWMva2liYW5hL2tpYmFuYTp0bXExZGhCeVRIYS16MG5FcGpRY2ln"

elasticsearch.ssl.verificationMode: full
elasticsearch.ssl.certificateAuthorities: [ "/etc/kibana/certs/full.crt" ]
logging:
  appenders:
    file:
      type: file
      fileName: /var/log/kibana/kibana.log
      layout:
        type: json
  root:
    appenders:
      - default
      - file
pid.file: /run/kibana/kibana.pid




━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#  OPTIONS 2: using .p12 certificates.
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Certificate Files Used
Extracted from STAR_sagar_com_np.zip:
  - STAR_sagar_com_np.crt — Domain certificate
  - sagar_com_np.key — Private key
  - AAACertificateServices.crt
  - USERTrustRSAAAACA.crt
  - SectigoRSADomainValidationSecureServerCA.crt

# Create a full chain certificate.
cat AAACertificateServices.crt USERTrustRSAAAACA.crt SectigoRSADomainValidationSecureServerCA.crt > full-chain.crt

# Creating PKCS#12 Keystore (sagar.p12)
openssl pkcs12 -export \
  -in STAR_sagar_com_np.crt \
  -inkey sagar_com_np.key \
  -certfile full-chain.crt \
  -out sagar.p12 \
  -password pass:changeit

# tuG*JM+yZrXNBT@%&c5$Qg
# openssl pkcs12 -export -in STAR_sagar_com_np.crt -inkey sagar_com_np.key -certfile full-chain.crt -out sagar.p12 -password pass:'tuG*JM+yZrXNBT@%&c5$Qg'

# Generate a Truststore (truststore.p12)
keytool -importcert \
  -alias sectigo-root \
  -file full-chain.crt \
  -keystore truststore.p12 \
  -storetype PKCS12 \
  -storepass changeit \
  -noprompt

# Generate a Truststore (truststore.p12)
# keytool -importcert -alias sectigo-root -file full-chain.crt -keystore truststore.p12 -storetype PKCS12 -storepass 'tuG*JM+yZrXNBT@%&c5$Qg' -noprompt

# elasticsearch keystore view, remove and add new for public certificate.
sudo -u elasticsearch /usr/share/elasticsearch/bin/elasticsearch-keystore list

# remove
sudo -u elasticsearch /usr/share/elasticsearch/bin/elasticsearch-keystore remove xpack.security.http.ssl.keystore.secure_password
sudo -u elasticsearch /usr/share/elasticsearch/bin/elasticsearch-keystore remove xpack.security.transport.ssl.keystore.secure_password
sudo -u elasticsearch /usr/share/elasticsearch/bin/elasticsearch-keystore remove xpack.security.transport.ssl.truststore.secure_password

# add
sudo -u elasticsearch /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.http.ssl.keystore.secure_password
sudo -u elasticsearch /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
sudo -u elasticsearch /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password

# password view
/usr/share/elasticsearch/bin/elasticsearch-keystore show autoconfiguration.password_hash
/usr/share/elasticsearch/bin/elasticsearch-keystore show keystore.seed
/usr/share/elasticsearch/bin/elasticsearch-keystore show xpack.security.http.ssl.keystore.secure_password
/usr/share/elasticsearch/bin/elasticsearch-keystore show xpack.security.transport.ssl.keystore.secure_password
/usr/share/elasticsearch/bin/elasticsearch-keystore show xpack.security.transport.ssl.truststore.secure_password

# permissions.
sudo chown -R elasticsearch:elasticsearch /etc/elasticsearch
chmod 640 /etc/elasticsearch/certs/sagar-crts/*.p12

# elasticsearch.yml
cluster.name: elk
node.name: elk.sagar.com.np
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: elk.sagar.com.np
http.port: 9200
http.host: 0.0.0.0
xpack.security.enabled: true
xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.keystore.path: /etc/elasticsearch/certs/sagar-crts/sagar.p12
# xpack.security.http.ssl.verification_mode: certificate # to fix the error: java.security.cert.CertificateException: No subject alternative names matching IP address 192.168.121.113 found
# xpack.security.http.ssl.verification_mode: full # enable this after password reset or leave it as comment.

xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: /etc/elasticsearch/certs/sagar-crts/sagar.p12
xpack.security.transport.ssl.truststore.path: /etc/elasticsearch/certs/sagar-crts/truststore.p12
cluster.initial_master_nodes: ["elk.sagar.com.np"]

# restart
sudo systemctl restart elasticsearch
sudo -u elasticsearch /usr/share/elasticsearch/bin/elasticsearch -v # this is the best way to check the logs


#  Copy the certificates to kibana/certs path
cp /etc/elasticsearch/certs/sagar-crts/STAR_sagar_com_np.crt \
  /etc/elasticsearch/certs/sagar-crts/sagar_com_np.key \  
  /etc/elasticsearch/certs/sagar-crts/full-chain.crt  \
  /etc/kibana/certs/.

# update permission
sudo chown kibana:kibana /etc/kibana/certs/*
chmod 640 /etc/kibana/certs/*

# kibana.yml
config kibana
server.port: 5601
server.host: "0.0.0.0"
server.publicBaseUrl: "https://kibana.sagar.com.np:5601"
server.name: "kibana.sagar.com.np"
server.ssl.enabled: true
server.ssl.certificate: /etc/kibana/certs/STAR_sagar_com_np.crt
server.ssl.key: /etc/kibana/certs/sagar_com_np.key
elasticsearch.hosts: ["https://elk.sagar.com.np:9200"]
elasticsearch.ssl.certificateAuthorities: ["/etc/kibana/certs/full-chain.crt"]
elasticsearch.ssl.verificationMode: full
elasticsearch.serviceAccountToken: "AAEAAWVsYXN0aWMva2liYW5hL2tpYmFuYTp0bXExZGhCeVRIYS16MG5FcGpRY2ln"
logging:
  appenders:
    file:
      type: file
      fileName: /var/log/kibana/kibana.log
      layout:
        type: json
  root:
    appenders:
      - default
      - file
pid.file: /run/kibana/kibana.pid



# restart the kibana
systemctl restart kibana
sudo -u kibana /usr/share/kibana/bin/kibana # this is the best way to check the logs

# certificate verification
openssl s_client -connect elk.sagar.com.np:9200 -showcerts


openssl x509 -noout -modulus -in /etc/kibana/certs/STAR_sagar_com_np.crt | openssl md5
openssl rsa -noout -modulus -in /etc/kibana/certs/sagar_com_np.key | openssl md5
# output must be same.


Login user: elastic
Login password: Ela5Tic@#987

#### metricbeat
cd /tmp
wget https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.17.0-x86_64.rpm
sudo rpm -ivh metricbeat-8.17.0-x86_64.rpm

cp metricbeat.yml  metricbeat.yml_20250411



sudo vim /etc/metricbeat/metricbeat.yml
metricbeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: false
setup.template.settings:
  index.number_of_shards: 1
  index.codec: best_compression
setup.kibana:
  host: "dc-kibana.sagar.com.np:5601"
output.elasticsearch:
  hosts: ["https://dc-elk.sagar.com.np:9200"]
  preset: balanced
  protocol: "https"
  username: "elastic"
  password: "Ela5Tic@#987"
processors:
  - add_host_metadata: ~
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
  - add_kubernetes_metadata: ~



sudo metricbeat modules enable system
sudo metricbeat setup --dashboards

sudo systemctl enable metricbeat
sudo systemctl start metricbeat
journalctl -u metricbeat -f




# api generate
curl -u elastic:Ela5Tic@#987 -X POST "http://dc-elk.sagar.com.np:9200/_security/api_key" -H 'Content-Type: application/json' -d '{
  "name": "metricbeat-api-key",
  "role_descriptors": {
    "metricbeat_writer": {
      "cluster": ["monitor", "read_ilm"],
      "index": [
        {
          "names": ["metricbeat-*"],
          "privileges": ["write", "create_index"]
        }
      ]
    }
  }
}'

# kibana
POST /_security/api_key
{
  "name": "metricbeat-api-key",
  "role_descriptors": {
    "metricbeat_writer": {
      "cluster": ["monitor", "read_ilm"],
      "index": [
        {
          "names": ["metricbeat-*"],
          "privileges": ["write", "create_index"]
        }
      ]
    }
  }
}

# output
{
  "id": "7psRv5YBoEGT3O3BrBqD",
  "name": "metricbeat-api-key",
  "api_key": "YtfMfJsiSSeUVZV_EYQ0JA",
  "encoded": "N3BzUnY1WUJvRUdUM08zQnJCcUQ6WXRmTWZKc2lTU2VVVlpWX0VZUTBKQQ=="
}

